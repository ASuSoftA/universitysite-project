from app.ai_model.university_knowledge import search_knowledge, university_data
import random

class UniversityChatbot:

    def __init__(self):
        self.conversation_history = []

    def safe_random_choice(self, items):
        """ุฏุงูุฉ ุขููุฉ ูุงุฎุชูุงุฑ ุนูุตุฑ ุนุดูุงุฆู"""
        if isinstance(items, (list, tuple)):
            return random.choice(list(items))
        return items

    def generate_response(self, user_input):
        user_input = user_input.lower()
        self.conversation_history.append(('user', user_input))

        # ุงูุชุญูู ูู ุงูุชุญูุงุช
        greeting_response = self.check_greetings(user_input)
        if greeting_response:
            return greeting_response

        # ุงูุชุญูู ูู ุงููุฏุงุน
        farewell_response = self.check_farewell(user_input)
        if farewell_response:
            return farewell_response

        # ุงูุชุญูู ูู ุงูุฑุฏูุฏ ุงูุนุงุทููุฉ
        emotional_response = self.check_emotional_state(user_input)
        if emotional_response:
            return emotional_response

        # ุงูุชุญูู ูู ุงูุดูุฑ
        thanks_response = self.check_thanks(user_input)
        if thanks_response:
            return thanks_response

        # ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ
        knowledge_result = search_knowledge(user_input)

        if knowledge_result:
            response = self.format_response(knowledge_result)
            # ุฅุถุงูุฉ ุงูุชุฑุงุญุงุช ุจุนุฏ ุงูุฅุฌุงุจุฉ
            if len(self.conversation_history) > 2:
                response += self.add_suggestions()
            return response

        return self.get_fallback_response()
    

    def check_greetings(self, user_input):
        """ุงูุชุญูู ูู ุฌููุน ุฃููุงุน ุงูุชุญูุฉ"""
        # ุชุญููู tuples ุฅูู lists ุฅุฐุง needed
        if isinstance(university_data['ุงูุชุญูุงุช']['ุตุจุงุญ_ุงูุฎูุฑ'], tuple):
            university_data['ุงูุชุญูุงุช']['ุตุจุงุญ_ุงูุฎูุฑ'] = list(university_data['ุงูุชุญูุงุช']['ุตุจุงุญ_ุงูุฎูุฑ'])
        if isinstance(university_data['ุงูุชุญูุงุช']['ูุณุงุก_ุงูุฎูุฑ'], tuple):
            university_data['ุงูุชุญูุงุช']['ูุณุงุก_ุงูุฎูุฑ'] = list(university_data['ุงูุชุญูุงุช']['ูุณุงุก_ุงูุฎูุฑ'])
        
        greetings = {
            'ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู': [
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ๐ธ ููู ุญุงูู ุงููููุ',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ๐ซ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ๐ ุฃููุงู ูุณููุงู ุจู'
            ],
            'ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู': [
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ธ ููู ูููููู ุฎุฏูุชูุ',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ซ ุฃููุงู ุจู',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ ููู ุญุงููุ'
            ],
            'ุงูุณูุงู ุนูููู': [
                'ูุนูููู ุงูุณูุงู! ๐ธ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ูุนูููู ุงูุณูุงู! ๐ซ ุฃููุงู ูุณููุงู',
                'ูุนูููู ุงูุณูุงู! ๐ ููู ุญุงูู ุงูููู๏ผ'
            ],
            'ุณูุงู ุนูููู': [
                'ูุนูููู ุงูุณูุงู! ๐ธ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ูุนูููู ุงูุณูุงู! ๐ซ ุฃููุงู ูุณููุงู',
                'ูุนูููู ุงูุณูุงู! ๐ ููู ุญุงููุ'
            ],
            'ุนูููู ุงูุณูุงู': [
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ธ',
                'ูุนูููู ุงูุณูุงู! ๐ซ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ูุนูููู ุงูุณูุงู! ๐ ุฃููุงู ุจู'
            ],
            'ุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู': [
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ๐ธ',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ซ ููู ุญุงููุ',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู! ๐ ุฃููุงู ูุณููุงู'
            ],
            'ุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู': [
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ๐ธ',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ๐ซ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู! ๐ ุฃููุงู ุจู'
            ],
            'ุงูุณูุงู': [
                'ูุนูููู ุงูุณูุงู! ๐ธ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ูุนูููู ุงูุณูุงู! ๐ซ ุฃููุงู ูุณููุงู',
                'ูุนูููู ุงูุณูุงู! ๐ ููู ุญุงููุ'
            ],
            'ุณูุงู': [
                'ูุนูููู ุงูุณูุงู! ๐ธ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ุณูุงู! ๐ซ ููู ูููููู ูุณุงุนุฏุชูุ',
                'ูุนูููู ุงูุณูุงู! ๐ ุฃููุงู ุจู'
            ],
            'ูุฑุญุจุง': ['ูุฑุญุจุงู! ๐ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ', 'ุฃููุงู ูุณููุงู! ๐ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ'],
            'ุงููุง': ['ุฃููุงู ุจู! ๐ซ ููู ูููููู ุฎุฏูุชูุ' ],
            'ููุง': ['ุฃููุงู ุจู! ๐ซ ููู ูููููู ุฎุฏูุชูุ', 'ุฃููุงู! ๐  ููู ูููููู ุฎุฏูุชูุ'],
            
            'ุตุจุงุญ ุงูุฎูุฑ': [
            "ุตุจุงุญ ุงูููุฑ!", "ุตุจุงุญ ุงูุฎูุฑ! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
            "ุฃููุงู! ุตุจุงุญ ุงูุฎูุฑ ๐"
        ],
            'ูุณุงุก ุงูุฎูุฑ': ["ูุณุงุก ุงูููุฑ!", "ูุณุงุก ุงูุฎูุฑ! ููู ุญุงููุ", "ุฃููุงู! ูุณุงุก ุงูุฎูุฑ ๐"],
            
            'hello': ['Hello! ๐ How can I help you?', 'Hi there! ๐'],
            'hi': ['Hi! ๐ซ Welcome to our university chatbot!'],
        }

        # ุงูุชุญูู ูู ุฌููุน ุตูุบ ุงูุณูุงู ุฃููุงู
        islamic_greetings = {
            'ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู': greetings['ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู'],
            'ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู': greetings['ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู'],
            'ุงูุณูุงู ุนูููู': greetings['ุงูุณูุงู ุนูููู'],
            'ุณูุงู ุนูููู': greetings['ุณูุงู ุนูููู'],
            'ุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู': greetings['ุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู'],
            'ุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู': greetings['ุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู'],
            'ุนูููู ุงูุณูุงู': greetings['ุนูููู ุงูุณูุงู'],
            'ุงูุณูุงู': greetings['ุงูุณูุงู'],
            'ุณูุงู': greetings['ุณูุงู']
        }

        for greeting, responses in islamic_greetings.items():
            if greeting in user_input:
                return random.choice(responses)

        # ุซู ุงูุชุญูู ูู ุงูุชุญูุงุช ุงูุฃุฎุฑู
        for greeting, responses in greetings.items():
            if greeting in user_input and greeting not in islamic_greetings:
                return random.choice(responses)

        # ุชุญูุงุช ุนุงูุฉ ุฅุฐุง ูู ูุชู ุงูุชุนุฑู ุนูู ุชุญูุฉ ูุญุฏุฏุฉ
        general_greetings = [
            "ุฃููุงู! ๐ ููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
            "ูุฑุญุจุงู ุจู! ๐ซ ุฃูุง ุงููุณุงุนุฏ ุงูุฐูู ููุฌุงูุนุฉ",
            "ุฃููุงู ูุณููุงู! ๐ ููู ูููููู ุฎุฏูุชูุ",
            "ุงูุณูุงู ุนูููู! ๐ธ ููู ูููููู ูุณุงุนุฏุชูุ"
        ]

        if any(word in user_input for word in ['ุงูููู', 'ูุฑุญุจุฉ', 'ูุงู', 'ุงููุงููู', 'ูุงู']):
            return random.choice(general_greetings)

        return None

    def check_farewell(self, user_input):
        """ุงูุชุญูู ูู ุฌููุน ุฃููุงุน ุงููุฏุงุน"""
        farewells = {
            'ูุน ุงูุณูุงูุฉ': ["ุฅูู ุงูููุงุก! ๐", "ูุงูุช ูุญุงุฏุซุฉ ููุชุนุฉ! ๐ซ"],
            'ูุฏุงุนุง': ['ุฅูู ุงูููุงุก! ๐', 'ูุงูุช ูุญุงุฏุซุฉ ููุชุนุฉ! ๐ซ'],
            'ุจุงู': ['Bye! ๐ Take care!', 'See you later! ๐'],
            'goodbye': ['Goodbye! ๐ Have a great day!'],
            'ุชุตุจุญ ุนูู ุฎูุฑ': [" ูุฃูุช ูู ุฃูู ุฎูุฑ! ๐", "ุชูุงูู ุงูุฎูุฑ! ๐","ูููุฉ ุณุนูุฏุฉ! ๐", "ุฃุญูุงู ุณุนูุฏุฉ! ๐ซ"],
            'ูููุฉ ุณุนูุฏุฉ': ['ุฃุญูุงู ุณุนูุฏุฉ! ๐', 'ุชุตุจุญ ุนูู ุฎูุฑ! ๐ซ'],
            'ุงูุชููุช': ['ุญุณูุงู! ๐ ูุง ุชุชุฑุฏุฏ ูู ุงูุณุคุงู anytime!', 'ุฃุชููู ูู ูููุงู ููุชุงุฒุงู! ๐'],
            'ููุงูุฉ': ['ุญุณูุงู! ๐ ุฃูุง ููุง ุฅุฐุง ุงุญุชุฌุชูู', 'ุชู ุงูุฃูุฑ! ๐ซ ุฅูู ุงูููุงุก!']
        }

        for farewell, responses in farewells.items():
            if farewell in user_input:
                # ุฅุถุงูุฉ ุฑุฏ ุดูุฑ ุฅุฐุง ูุงู ููุงุณุจุงู
                if any(word in user_input for word in ['ุดูุฑุง', 'ูุชุดูุฑ', 'thanks']):
                    thank_response = self.safe_random_choice(university_data['ุงููุฏุงุน']['ุดูุฑ_ุจุนุฏ_ูุฏุงุน'])
                    return f"{random.choice(responses)} {thank_response}"
                return random.choice(responses)

        return None

    def check_emotional_state(self, user_input):
        """ุงูุชุญูู ูู ุงูุญุงูุฉ ุงููุฒุงุฌูุฉ ูุงูุนุงุทููุฉ"""
        emotional_states = {
            'ุงูุญูุฏ ููู': ["ุงูุญูุฏ ููู ุฏุงุฆูุงู ๐", "ุงููู ูุณููู ๐น", "ุงูุญูุฏ ููู ุนูู ูู ุญุงู ๐"],
            'ุชุณูู': ["ุงููู ูุณููู ๐น"],
            'ูุณููู': ["ุงููู ูุณููู ๐น"],
            'ููู ุงูุญุงู': ["ุงูุญูุฏ ููู ุฏุงุฆูุงู ๐", "ุงูุญูุฏ ููู ุนูู ูู ุญุงู ๐"],
            'ูููู': ["ุงูุญูุฏ ููู ุฏุงุฆูุงู ๐", "ุงูุญูุฏ ููู ุนูู ูู ุญุงู ๐"],
            'ููู ุญุงูู': ["ุงูุญูุฏ ููู ุฏุงุฆูุงู ๐", "ุงูุญูุฏ ููู ุนูู ูู ุญุงู ๐"],
            'ููููู': ["ุงูุญูุฏ ููู ุฏุงุฆูุงู ๐", "ุงูุญูุฏ ููู ุนูู ูู ุญุงู ๐"],
            'ุจุฎูุฑ': ["ุงููู ูุณุนุฏู! ๐", "ุงูุญูุฏ ููู ๐ธ", "ุฐูู ุฑุงุฆุน! ๐"],
            'ุชูุงู': ['ุงููู ูุณุนุฏู! ๐ธ', 'ุฐูู ููุชุงุฒ! ๐ซ'],
            'ููุชุงุฒ': ['ุฑุงุฆุน! ๐', 'ุฐูู ุฑุงุฆุน! ๐'],
            'ุชุนุจุงู': ["ุฃุชููู ูู ุงูุฑุงุญุฉ ุณุฑูุนุงู ๐ธ", "ุงููู ูุนููู ููุดููไฝ ๐","ุฎุฐ ูุณุทุงู ูู ุงูุฑุงุญุฉ ๐ซ"],
            'ูุชุนุจ': ["ุฃุชููู ูู ุงูุฑุงุญุฉ ุณุฑูุนุงู ๐ธ", "ุงููู ูุนููู ููุดููไฝ ๐","ุฎุฐ ูุณุทุงู ูู ุงูุฑุงุญุฉ ๐ซ"],
            'ุฒุนูุงู': ['ุงููู ููุฑุฌ ููู ๐คฒ', 'ุฅู ุดุงุก ุงููู ุชุชุญุณู ุงูุฃููุฑ ๐'],
            'ุญุฒูู': ['ุฃูุง ููุง ููุณุงุนุฏุชู ๐ซ', 'ุงููู ูุจุฏู ุญุฒูู ูุฑุญุงู ๐ธ'],
            'ุณุนูุฏ': ['ุงูุญูุฏ ููู! ๐', 'ุฐูู ูุฌุนููู ุณุนูุฏุงู ุฃูุถุงู! ๐']
            
        }

        for state, responses in emotional_states.items():
            if state in user_input:
                return random.choice(responses)

        return None

    def check_thanks(self, user_input):
        """ุงูุชุญูู ูู ุงูุดูุฑ"""
        thanks_keywords = ['ุดูุฑุง', 'ูุชุดูุฑ', 'thank you', 'thanks', 'ูุดููุฑ', 'ูุนุทูู ุงูุนุงููุฉ']

        if any(word in user_input for word in thanks_keywords):
            responses = [
                "ุงูุนูู! ๐ ุฏุงุฆูุงู ุณุนูุฏ ุจูุณุงุนุฏุชู",
                "ูุง ุดูุฑ ุนูู ูุงุฌุจ! ๐ธ",
                "ุฃูุช welcome! ๐ซ",
                "ูู ุฏูุงุนู ุณุฑูุฑู! ๐",
                "ุฃู ููุช! ๐"
            ]
            return random.choice(responses)

        return None

    def add_suggestions(self):
        """ุฅุถุงูุฉ ุงูุชุฑุงุญุงุช ุฃุณุฆูุฉ"""
        suggestions = [
            "\n\n๐ก **ูู ุชุฑูุฏ ูุนุฑูุฉ:**",
            "- ูุนูููุงุช ุนู ุงูุฃูุณุงู ุงูุฏุฑุงุณูุฉุ",
            "- ุฑุณูู ุงูุฏุฑุงุณุฉ ูุงูููุญุ", 
            "- ุนูููุฉ ุงูุชุณุฌูู ูุงูุดุฑูุทุ",
            "- ูุฑุงูู ุงูุฌุงูุนุฉ ูุงูุฎุฏูุงุชุ",
            "\nุงุทุฑุญ ุนูู ุฃู ุณุคุงู! ๐"
        ]
        return "\n".join(suggestions)

    def get_fallback_response(self):
        """ุฑุฏ ุนูุฏูุง ูุง ูููู ุงูุณุคุงู"""
        fallbacks = [
            "ุนุฐุฑุงูุ ูู ุฃููู ุณุคุงูู ุจุดูู ูุงูู. ููููู ุทุฑุญ ุฃุณุฆูุฉ ุนู ุงูุฃูุณุงูุ ุงูุฑุณุงูุฉุ ุงูุฑุคูุฉุ ุฃู ูุนูููุงุช ุงูุงุชุตุงู.",
            "ูู ููููู ุฅุนุงุฏุฉ ุตูุงุบุฉ ุณุคุงููุ ุฃุฑูุฏ ูุณุงุนุฏุชู ูู ุงูุญุตูู ุนูู ุงููุนูููุงุช ุงูุชู ุชุจุญุซ ุนููุง.",
            "ุฃูุง ูุชุฎุตุต ูู ูุนูููุงุช ุงูุฌุงูุนุฉ. ููููู ุณุคุงูู ุนู ุงูุฃูุณุงูุ ุงูุจุฑุงูุฌุ ุงูุฑุณููุ ุฃู ุนูููุฉ ุงูุชุณุฌูู.",
            "ุฑุจูุง ูููููู ูุณุงุนุฏุชู ุจุดูู ุฃูุถู ุฅุฐุง ุดุฑุญุช ูู ูุง ุชุฑูุฏ ูุนุฑูุชู ุนู ุงูุฌุงูุนุฉ.",
            "ูู ุชูุตุฏ ุงุณุชูุณุงุฑุงู ุนู: ุงูุฃูุณุงูุ ุงูุฑุณููุ ุงูุชุณุฌููุ ุฃู ุดูุก ุขุฎุฑุ"
        ]
        return random.choice(fallbacks)

    def format_response(self, data):
        """ุชูุณูู ุงูุจูุงูุงุช ูุนุฑุถูุง ุจุดูู ููุฑูุก"""
        if isinstance(data, str):
            return data

        elif isinstance(data, list):
            response = ""
            for i, item in enumerate(data, 1):
                response += f"{i}. {item}\n"
            return response

        elif isinstance(data, dict):
            response = ""
            for key, value in data.items():
                readable_key = key.replace('_', ' ')
                if isinstance(value, (list, dict)):
                    response += f"\n**{readable_key}:**\n"
                    response += self.format_response(value)
                else:
                    response += f"**{readable_key}:** {value}\n"
            return response

        return str(data)